<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recipes with rsample • rsample</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<meta property="og:title" content="Recipes with rsample">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">rsample</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../articles/Basics.html">Basic Usage</a>
</li>
<li>
  <a href="../../articles/Working_with_rsets.html">Working with Resample Sets</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Application Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/Applications/Recipes_and_rsample.html">Recipes and rsample</a>
    </li>
    <li>
      <a href="../../articles/Applications/Time_Series.html">Time Series Analysis</a>
    </li>
    <li>
      <a href="../../articles/Applications/Survival_Analysis.html">Survival Analysis</a>
    </li>
    <li>
      <a href="../../articles/Applications/Nested_Resampling.html">Tuning Models using Nested Resampling</a>
    </li>
    <li>
      <a href="../../articles/Applications/Keras.html">Grid Search Tuning of Keras Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Recipes with rsample</h1>
            
      
      
      <div class="hidden name"><code>Recipes_and_rsample.Rmd</code></div>

    </div>

    
    
<p>The <a href="https://topepo.github.io/recipes/"><code>recipes</code></a> package contains a data preprocessor that can be used to avoid the potentially expensive formula methods as well as providing a richer set of data manipulation tools than base R can provide. This document uses version 0.1.2.9000 of <code>recipes</code>.</p>
<p>In many cases, the preprocessing steps might contain quantities that require statistical estimation of parameters, such as</p>
<ul>
<li><p>signal extraction using principal component analysis</p></li>
<li><p>imputation of missing values</p></li>
<li><p>transformations of individual variables (e.g. Box-Cox transformations)</p></li>
</ul>
<p>It is critical that any complex preprocessing steps be contained <em>inside</em> of resampling so that the model performance estimates take into account the variability of these steps.</p>
<p>Before discussing how <code>rsample</code> can use recipes, let’s look at an example recipe for the Ames housing data.</p>
<div id="an-example-recipe" class="section level2">
<h2 class="hasAnchor">
<a href="#an-example-recipe" class="anchor"></a>An Example Recipe</h2>
<p>For illustration, the Ames housing data will be used. There are sale prices of homes along with various other descriptors for the property:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(AmesHousing)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">ames &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/AmesHousing/topics/make_ames">make_ames</a></span>()</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">names</span>(ames)</a></code></pre></div>
<pre><code>##  [1] "MS_SubClass"        "MS_Zoning"          "Lot_Frontage"      
##  [4] "Lot_Area"           "Street"             "Alley"             
##  [7] "Lot_Shape"          "Land_Contour"       "Utilities"         
## [10] "Lot_Config"         "Land_Slope"         "Neighborhood"      
## [13] "Condition_1"        "Condition_2"        "Bldg_Type"         
## [16] "House_Style"        "Overall_Qual"       "Overall_Cond"      
## [19] "Year_Built"         "Year_Remod_Add"     "Roof_Style"        
## [22] "Roof_Matl"          "Exterior_1st"       "Exterior_2nd"      
## [25] "Mas_Vnr_Type"       "Mas_Vnr_Area"       "Exter_Qual"        
## [28] "Exter_Cond"         "Foundation"         "Bsmt_Qual"         
## [31] "Bsmt_Cond"          "Bsmt_Exposure"      "BsmtFin_Type_1"    
## [34] "BsmtFin_SF_1"       "BsmtFin_Type_2"     "BsmtFin_SF_2"      
## [37] "Bsmt_Unf_SF"        "Total_Bsmt_SF"      "Heating"           
## [40] "Heating_QC"         "Central_Air"        "Electrical"        
## [43] "First_Flr_SF"       "Second_Flr_SF"      "Low_Qual_Fin_SF"   
## [46] "Gr_Liv_Area"        "Bsmt_Full_Bath"     "Bsmt_Half_Bath"    
## [49] "Full_Bath"          "Half_Bath"          "Bedroom_AbvGr"     
## [52] "Kitchen_AbvGr"      "Kitchen_Qual"       "TotRms_AbvGrd"     
## [55] "Functional"         "Fireplaces"         "Fireplace_Qu"      
## [58] "Garage_Type"        "Garage_Finish"      "Garage_Cars"       
## [61] "Garage_Area"        "Garage_Qual"        "Garage_Cond"       
## [64] "Paved_Drive"        "Wood_Deck_SF"       "Open_Porch_SF"     
## [67] "Enclosed_Porch"     "Three_season_porch" "Screen_Porch"      
## [70] "Pool_Area"          "Pool_QC"            "Fence"             
## [73] "Misc_Feature"       "Misc_Val"           "Mo_Sold"           
## [76] "Year_Sold"          "Sale_Type"          "Sale_Condition"    
## [79] "Sale_Price"         "Longitude"          "Latitude"</code></pre>
<p>Suppose that we will again fit a simple regression model with the formula:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">log10</span>(Sale_Price) <span class="op">~</span><span class="st"> </span>Neighborhood <span class="op">+</span><span class="st"> </span>House_Style <span class="op">+</span><span class="st"> </span>Year_Sold <span class="op">+</span><span class="st"> </span>Lot_Area</a></code></pre></div>
<p>The distribution of the lot size is right-skewed:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/theme_get">theme_set</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>())</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(ames, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> Lot_Area)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_histogram">geom_histogram</a></span>(<span class="dt">binwidth =</span> <span class="dv">5000</span>, <span class="dt">col =</span> <span class="st">"red"</span>, <span class="dt">fill =</span><span class="st">"red"</span>, <span class="dt">alpha =</span> <span class="fl">.5</span>)</a></code></pre></div>
<p><img src="Recipes_and_rsample_files/figure-html/build-1.png" width="700"></p>
<p>It might benefit the model if we estimate a transformation of the data using the Box-Cox procedure.</p>
<p>Also, note that the frequencies of the neighborhoods can vary:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(ames, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> Neighborhood)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_bar">geom_bar</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/coord_flip">coord_flip</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">""</span>)</a></code></pre></div>
<p><img src="Recipes_and_rsample_files/figure-html/hood-1.png" width="700"></p>
<p>When these are resampled, some neighborhoods will not be included in the test set and this will result in a column of dummy variables with zero entires. The same is true for the <code>House_Style</code> variable. We might want to collapse rarely occurring values into “other” categories.</p>
<p>To define the design matrix, an initial recipe is created:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">library</span>(recipes)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">rec &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/recipe">recipe</a></span>(Sale_Price <span class="op">~</span><span class="st"> </span>Neighborhood <span class="op">+</span><span class="st"> </span>House_Style <span class="op">+</span><span class="st"> </span>Year_Sold <span class="op">+</span><span class="st"> </span>Lot_Area, </a>
<a class="sourceLine" id="cb6-4" data-line-number="4">              <span class="dt">data =</span> ames) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="st">  </span><span class="co"># Log the outcome</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/step_log">step_log</a></span>(Sale_Price, <span class="dt">base =</span> <span class="dv">10</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="st">  </span><span class="co"># Collapse rarely occurring jobs into "other"</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/step_other">step_other</a></span>(Neighborhood, House_Style, <span class="dt">threshold =</span> <span class="fl">0.05</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="st">  </span><span class="co"># Dummy variables on the qualitative predictors</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/step_dummy">step_dummy</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/has_role">all_nominal</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="st">  </span><span class="co"># Unskew a predictor</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/step_BoxCox">step_BoxCox</a></span>(Lot_Area) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="st">  </span><span class="co"># Normalize</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/step_center">step_center</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/has_role">all_predictors</a></span>()) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/step_scale">step_scale</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/has_role">all_predictors</a></span>()) </a>
<a class="sourceLine" id="cb6-16" data-line-number="16">rec</a></code></pre></div>
<pre><code>## Data Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          4
## 
## Operations:
## 
## Log transformation on Sale_Price
## Collapsing factor levels for Neighborhood, House_Style
## Dummy variables from all_nominal()
## Box-Cox transformation on Lot_Area
## Centering for all_predictors()
## Scaling for all_predictors()</code></pre>
<p>This recreates the work that the formula method traditionally uses with the additional steps.</p>
<p>While the original data object <code>ames</code> is used in the call, it is only used to define the variables and their characteristics so a single recipe is valid across all resampled versions of the data. The recipe can be estimated on the analysis component of the resample.</p>
<p>If we execute the recipe on the entire data set:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">rec_training_set &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/prep">prep</a></span>(rec, <span class="dt">training =</span> ames, <span class="dt">retain =</span> <span class="ot">TRUE</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## oper 1 step log [training] 
## oper 2 step other [training] 
## oper 3 step dummy [training] 
## oper 4 step BoxCox [training] 
## oper 5 step center [training] 
## oper 6 step scale [training]</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">rec_training_set</a></code></pre></div>
<pre><code>## Data Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          4
## 
## Training data contained 2930 data points and no missing data.
## 
## Operations:
## 
## Log transformation on Sale_Price [trained]
## Collapsing factor levels for Neighborhood, House_Style [trained]
## Dummy variables from Neighborhood, House_Style [trained]
## Box-Cox transformation on Lot_Area [trained]
## Centering for Year_Sold, ... [trained]
## Scaling for Year_Sold, ... [trained]</code></pre>
<p>To get the values of the data, the <code>bake</code> function can be used:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># By default, the selector `everything()` is used to </span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co"># return all the variables. Other selectors can be used too. </span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/bake">bake</a></span>(rec_training_set, <span class="dt">newdata =</span> <span class="kw">head</span>(ames))</a></code></pre></div>
<pre><code>## # A tibble: 6 x 14
##   Lot_Area Year_Sold Sale_Price Neighborhood_College_… Neighborhood_Old_T…
##      &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;                  &lt;dbl&gt;               &lt;dbl&gt;
## 1    2.70       1.68       5.33                 -0.317              -0.298
## 2    0.506      1.68       5.02                 -0.317              -0.298
## 3    0.930      1.68       5.24                 -0.317              -0.298
## 4    0.423      1.68       5.39                 -0.317              -0.298
## 5    0.865      1.68       5.28                 -0.317              -0.298
## 6    0.197      1.68       5.29                 -0.317              -0.298
## # ... with 9 more variables: Neighborhood_Edwards &lt;dbl&gt;,
## #   Neighborhood_Somerset &lt;dbl&gt;, Neighborhood_Northridge_Heights &lt;dbl&gt;,
## #   Neighborhood_Gilbert &lt;dbl&gt;, Neighborhood_Sawyer &lt;dbl&gt;,
## #   Neighborhood_other &lt;dbl&gt;, House_Style_One_Story &lt;dbl&gt;,
## #   House_Style_Two_Story &lt;dbl&gt;, House_Style_other &lt;dbl&gt;</code></pre>
<p>Note that there are fewer dummy variables for <code>Neighborhood</code> and <code>House_Style</code> than in the data.</p>
<p>Also, <code>retain</code> keeps the processed version of the data set so that we don’t have to reapply the steps to extract the processed values. For the data used to train the recipe, we would have used:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/juice">juice</a></span>(rec_training_set) <span class="op">%&gt;%</span><span class="st"> </span>head</a></code></pre></div>
<pre><code>## # A tibble: 6 x 14
##   Year_Sold Lot_Area Sale_Price Neighborhood_College_… Neighborhood_Old_T…
##       &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;                  &lt;dbl&gt;               &lt;dbl&gt;
## 1      1.68    2.70        5.33                 -0.317              -0.298
## 2      1.68    0.506       5.02                 -0.317              -0.298
## 3      1.68    0.930       5.24                 -0.317              -0.298
## 4      1.68    0.423       5.39                 -0.317              -0.298
## 5      1.68    0.865       5.28                 -0.317              -0.298
## 6      1.68    0.197       5.29                 -0.317              -0.298
## # ... with 9 more variables: Neighborhood_Edwards &lt;dbl&gt;,
## #   Neighborhood_Somerset &lt;dbl&gt;, Neighborhood_Northridge_Heights &lt;dbl&gt;,
## #   Neighborhood_Gilbert &lt;dbl&gt;, Neighborhood_Sawyer &lt;dbl&gt;,
## #   Neighborhood_other &lt;dbl&gt;, House_Style_One_Story &lt;dbl&gt;,
## #   House_Style_Two_Story &lt;dbl&gt;, House_Style_other &lt;dbl&gt;</code></pre>
<p>The next section will explore recipes and bootstrap resampling for modeling:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">library</span>(rsample)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw">set.seed</span>(<span class="dv">7712</span>)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">bt_samples &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/bootstraps.html">bootstraps</a></span>(ames)</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">bt_samples</a></code></pre></div>
<pre><code>## # Bootstrap sampling 
## # A tibble: 25 x 2
##    splits       id         
##    &lt;list&gt;       &lt;chr&gt;      
##  1 &lt;S3: rsplit&gt; Bootstrap01
##  2 &lt;S3: rsplit&gt; Bootstrap02
##  3 &lt;S3: rsplit&gt; Bootstrap03
##  4 &lt;S3: rsplit&gt; Bootstrap04
##  5 &lt;S3: rsplit&gt; Bootstrap05
##  6 &lt;S3: rsplit&gt; Bootstrap06
##  7 &lt;S3: rsplit&gt; Bootstrap07
##  8 &lt;S3: rsplit&gt; Bootstrap08
##  9 &lt;S3: rsplit&gt; Bootstrap09
## 10 &lt;S3: rsplit&gt; Bootstrap10
## # ... with 15 more rows</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">bt_samples<span class="op">$</span>splits[[<span class="dv">1</span>]]</a></code></pre></div>
<pre><code>## &lt;2930/1076/2930&gt;</code></pre>
</div>
<div id="working-with-resamples" class="section level2">
<h2 class="hasAnchor">
<a href="#working-with-resamples" class="anchor"></a>Working with Resamples</h2>
<p>We can add a recipe column to the tibble. <code>rsample</code> has a connivence function called <code>prepper</code> that can be used to call <code>prep</code> but has the split object as the first argument (for easier purrring):</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">library</span>(purrr)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"></a>
<a class="sourceLine" id="cb20-3" data-line-number="3">bt_samples<span class="op">$</span>recipes &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(bt_samples<span class="op">$</span>splits, prepper, <span class="dt">recipe =</span> rec, <span class="dt">retain =</span> <span class="ot">TRUE</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">bt_samples</a></code></pre></div>
<pre><code>## # Bootstrap sampling 
## # A tibble: 25 x 3
##    splits       id          recipes     
##    &lt;list&gt;       &lt;chr&gt;       &lt;list&gt;      
##  1 &lt;S3: rsplit&gt; Bootstrap01 &lt;S3: recipe&gt;
##  2 &lt;S3: rsplit&gt; Bootstrap02 &lt;S3: recipe&gt;
##  3 &lt;S3: rsplit&gt; Bootstrap03 &lt;S3: recipe&gt;
##  4 &lt;S3: rsplit&gt; Bootstrap04 &lt;S3: recipe&gt;
##  5 &lt;S3: rsplit&gt; Bootstrap05 &lt;S3: recipe&gt;
##  6 &lt;S3: rsplit&gt; Bootstrap06 &lt;S3: recipe&gt;
##  7 &lt;S3: rsplit&gt; Bootstrap07 &lt;S3: recipe&gt;
##  8 &lt;S3: rsplit&gt; Bootstrap08 &lt;S3: recipe&gt;
##  9 &lt;S3: rsplit&gt; Bootstrap09 &lt;S3: recipe&gt;
## 10 &lt;S3: rsplit&gt; Bootstrap10 &lt;S3: recipe&gt;
## # ... with 15 more rows</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">bt_samples<span class="op">$</span>recipes[[<span class="dv">1</span>]]</a></code></pre></div>
<pre><code>## Data Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          4
## 
## Training data contained 2930 data points and no missing data.
## 
## Operations:
## 
## Log transformation on Sale_Price [trained]
## Collapsing factor levels for Neighborhood, House_Style [trained]
## Dummy variables from Neighborhood, House_Style [trained]
## Box-Cox transformation on Lot_Area [trained]
## Centering for Year_Sold, ... [trained]
## Scaling for Year_Sold, ... [trained]</code></pre>
<p>Now, to fit the model, the fit function only needs the recipe as input. This is because the above code used <code>retain = TRUE</code>. Otherwise, the split objects would also be needed to <code>bake</code> the recipe (as it will in the prediction function below).</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">fit_lm &lt;-<span class="st"> </span><span class="cf">function</span>(rec_obj, ...) </a>
<a class="sourceLine" id="cb24-2" data-line-number="2">  <span class="kw">lm</span>(..., <span class="dt">data =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/juice">juice</a></span>(rec_obj, <span class="kw">everything</span>()))</a>
<a class="sourceLine" id="cb24-3" data-line-number="3"></a>
<a class="sourceLine" id="cb24-4" data-line-number="4">bt_samples<span class="op">$</span>lm_mod &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb24-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(</a>
<a class="sourceLine" id="cb24-6" data-line-number="6">    bt_samples<span class="op">$</span>recipes, </a>
<a class="sourceLine" id="cb24-7" data-line-number="7">    fit_lm, </a>
<a class="sourceLine" id="cb24-8" data-line-number="8">    Sale_Price <span class="op">~</span><span class="st"> </span>.</a>
<a class="sourceLine" id="cb24-9" data-line-number="9">  )</a>
<a class="sourceLine" id="cb24-10" data-line-number="10">bt_samples</a></code></pre></div>
<pre><code>## # Bootstrap sampling 
## # A tibble: 25 x 4
##    splits       id          recipes      lm_mod  
##    &lt;list&gt;       &lt;chr&gt;       &lt;list&gt;       &lt;list&gt;  
##  1 &lt;S3: rsplit&gt; Bootstrap01 &lt;S3: recipe&gt; &lt;S3: lm&gt;
##  2 &lt;S3: rsplit&gt; Bootstrap02 &lt;S3: recipe&gt; &lt;S3: lm&gt;
##  3 &lt;S3: rsplit&gt; Bootstrap03 &lt;S3: recipe&gt; &lt;S3: lm&gt;
##  4 &lt;S3: rsplit&gt; Bootstrap04 &lt;S3: recipe&gt; &lt;S3: lm&gt;
##  5 &lt;S3: rsplit&gt; Bootstrap05 &lt;S3: recipe&gt; &lt;S3: lm&gt;
##  6 &lt;S3: rsplit&gt; Bootstrap06 &lt;S3: recipe&gt; &lt;S3: lm&gt;
##  7 &lt;S3: rsplit&gt; Bootstrap07 &lt;S3: recipe&gt; &lt;S3: lm&gt;
##  8 &lt;S3: rsplit&gt; Bootstrap08 &lt;S3: recipe&gt; &lt;S3: lm&gt;
##  9 &lt;S3: rsplit&gt; Bootstrap09 &lt;S3: recipe&gt; &lt;S3: lm&gt;
## 10 &lt;S3: rsplit&gt; Bootstrap10 &lt;S3: recipe&gt; &lt;S3: lm&gt;
## # ... with 15 more rows</code></pre>
<p>To get predictions, the function needs three arguments: the splits (to get the assessment data), the recipe (to process them), and the model. To iterate over these, the function <code><a href="http://www.rdocumentation.org/packages/purrr/topics/map2">purrr::pmap</a></code> is used:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1">pred_lm &lt;-<span class="st"> </span><span class="cf">function</span>(split_obj, rec_obj, model_obj, ...) {</a>
<a class="sourceLine" id="cb26-2" data-line-number="2">  mod_data &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/bake">bake</a></span>(</a>
<a class="sourceLine" id="cb26-3" data-line-number="3">    rec_obj, </a>
<a class="sourceLine" id="cb26-4" data-line-number="4">    <span class="dt">newdata =</span> <span class="kw"><a href="../../reference/as.data.frame.rsplit.html">assessment</a></span>(split_obj),</a>
<a class="sourceLine" id="cb26-5" data-line-number="5">    <span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/has_role">all_predictors</a></span>(),</a>
<a class="sourceLine" id="cb26-6" data-line-number="6">    <span class="kw"><a href="http://www.rdocumentation.org/packages/recipes/topics/has_role">all_outcomes</a></span>()</a>
<a class="sourceLine" id="cb26-7" data-line-number="7">  ) </a>
<a class="sourceLine" id="cb26-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb26-9" data-line-number="9">  out &lt;-<span class="st"> </span>mod_data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(Sale_Price)</a>
<a class="sourceLine" id="cb26-10" data-line-number="10">  out<span class="op">$</span>predicted &lt;-<span class="st"> </span><span class="kw">predict</span>(model_obj, <span class="dt">newdata =</span> mod_data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span>Sale_Price))</a>
<a class="sourceLine" id="cb26-11" data-line-number="11">  out</a>
<a class="sourceLine" id="cb26-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb26-13" data-line-number="13"></a>
<a class="sourceLine" id="cb26-14" data-line-number="14">bt_samples<span class="op">$</span>pred &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb26-15" data-line-number="15"><span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map2">pmap</a></span>(</a>
<a class="sourceLine" id="cb26-16" data-line-number="16">    <span class="kw">lst</span>(</a>
<a class="sourceLine" id="cb26-17" data-line-number="17">      <span class="dt">split_obj =</span> bt_samples<span class="op">$</span>splits, </a>
<a class="sourceLine" id="cb26-18" data-line-number="18">      <span class="dt">rec_obj =</span> bt_samples<span class="op">$</span>recipes, </a>
<a class="sourceLine" id="cb26-19" data-line-number="19">      <span class="dt">model_obj =</span> bt_samples<span class="op">$</span>lm_mod</a>
<a class="sourceLine" id="cb26-20" data-line-number="20">    ),</a>
<a class="sourceLine" id="cb26-21" data-line-number="21">    pred_lm </a>
<a class="sourceLine" id="cb26-22" data-line-number="22">  )</a>
<a class="sourceLine" id="cb26-23" data-line-number="23">bt_samples</a></code></pre></div>
<pre><code>## # Bootstrap sampling 
## # A tibble: 25 x 5
##    splits       id          recipes      lm_mod   pred                
##    &lt;list&gt;       &lt;chr&gt;       &lt;list&gt;       &lt;list&gt;   &lt;list&gt;              
##  1 &lt;S3: rsplit&gt; Bootstrap01 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,076 × 2]&gt;
##  2 &lt;S3: rsplit&gt; Bootstrap02 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,105 × 2]&gt;
##  3 &lt;S3: rsplit&gt; Bootstrap03 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,102 × 2]&gt;
##  4 &lt;S3: rsplit&gt; Bootstrap04 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,015 × 2]&gt;
##  5 &lt;S3: rsplit&gt; Bootstrap05 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,070 × 2]&gt;
##  6 &lt;S3: rsplit&gt; Bootstrap06 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,058 × 2]&gt;
##  7 &lt;S3: rsplit&gt; Bootstrap07 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,081 × 2]&gt;
##  8 &lt;S3: rsplit&gt; Bootstrap08 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,048 × 2]&gt;
##  9 &lt;S3: rsplit&gt; Bootstrap09 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,090 × 2]&gt;
## 10 &lt;S3: rsplit&gt; Bootstrap10 &lt;S3: recipe&gt; &lt;S3: lm&gt; &lt;tibble [1,072 × 2]&gt;
## # ... with 15 more rows</code></pre>
<p>Calculating the RMSE:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">rmse &lt;-<span class="st"> </span><span class="cf">function</span>(dat) </a>
<a class="sourceLine" id="cb28-2" data-line-number="2">  <span class="kw">sqrt</span>(<span class="kw">mean</span>((dat<span class="op">$</span>Sale_Price <span class="op">-</span><span class="st"> </span>dat<span class="op">$</span>predicted)<span class="op">^</span><span class="dv">2</span>))</a>
<a class="sourceLine" id="cb28-3" data-line-number="3">bt_samples<span class="op">$</span>RMSE &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_dbl</a></span>(bt_samples<span class="op">$</span>pred, rmse)</a>
<a class="sourceLine" id="cb28-4" data-line-number="4"><span class="kw">summary</span>(bt_samples<span class="op">$</span>RMSE)</a></code></pre></div>
<pre><code>##    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. 
##   0.122   0.126   0.130   0.130   0.133   0.140</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#an-example-recipe">An Example Recipe</a></li>
      <li><a href="#working-with-resamples">Working with Resamples</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Max Kuhn, <a href="http://hadley.nz">Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
