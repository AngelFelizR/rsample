<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grid Search Tuning of Keras Models • rsample</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><link href="../../extra.css" rel="stylesheet">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../index.html">rsample</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../articles/Basics.html">Basic Usage</a>
</li>
<li>
  <a href="../../articles/Working_with_rsets.html">Working with Resample Sets</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Application Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/Applications/Recipes_and_rsample.html">Recipes and rsample</a>
    </li>
    <li>
      <a href="../../articles/Applications/Time_Series.html">Time Series Analysis</a>
    </li>
    <li>
      <a href="../../articles/Applications/Survival_Analysis.html">Survival Analysis</a>
    </li>
    <li>
      <a href="../../articles/Applications/Nested_Resampling.html">Tuning Models using Nested Resampling</a>
    </li>
    <li>
      <a href="../../articles/Applications/Keras.html">Grid Search Tuning of Keras Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Grid Search Tuning of Keras Models</h1>
            
          </div>

    
    
<div class="contents">
<p>Here we demonstrate a simple grid search to optimize a tuning parameter of a <a href="https://keras.rstudio.com/index.html"><code>keras</code></a> neural network.</p>
<p>The Ames housing data is used to demonstrate. There are a number of predictors for these data but, for simplicity, we’ll see how far we can get by just using the geocodes for the properties as predictors of price. The outcome will be modeled on the log10 scale.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(AmesHousing)
<span class="kw">library</span>(dplyr)
ames &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/AmesHousing/topics/make_ames">make_ames</a></span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(Sale_Price, Longitude, Latitude)</code></pre></div>
<p>To be consistent with other analyses of these data, a training/test split is made. However, this article focuses on the training set.</p>
<p>Normally, feature preprocessing should be estimated within the resampling process to get generalizable estimates of performance. Here, the two predictors are simply centered and scaled beforehand to avoid complexity in this analysis. However, this is generally a bad idea and the article on <a href="https://topepo.github.io/rsample/articles/Applications/Recipes_and_rsample.html"><code>recipes</code></a> describes a proper methodology for preprocessing the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rsample)
<span class="kw">set.seed</span>(<span class="dv">4595</span>)
data_split &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/initial_split.html">initial_split</a></span>(ames, <span class="dt">strata =</span> <span class="st">"Sale_Price"</span>)

ames_train &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/initial_split.html">training</a></span>(data_split) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Sale_Price =</span> <span class="kw">log10</span>(Sale_Price),
         <span class="dt">Longitude  =</span> <span class="kw">scale</span>(Longitude, <span class="dt">center =</span> <span class="ot">TRUE</span>),
         <span class="dt">Latitude   =</span> <span class="kw">scale</span>(Latitude, <span class="dt">center =</span> <span class="ot">TRUE</span>))</code></pre></div>
<p>The resample the model, simple 10-fold cross-validation is done such that the splits use the outcome as a stratification variable. On average, there should be 218 properties in the assessment set and this should be enough to obtain good estimates of the model RMSE.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">2453</span>)
cv_splits &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/vfold_cv.html">vfold_cv</a></span>(ames_train, <span class="dt">v =</span> <span class="dv">10</span>, <span class="dt">strata =</span> <span class="st">"Sale_Price"</span>)</code></pre></div>
<p>A single layer feed-forward neural network with 10 hidden units will be used to model these data. There are a great many tuning parameters for these models including those for structural aspects (e.g. number of hidden units, activation type, number of layers), the optimization (momentum, dropout rate, etc.), and so on. For simplicity, this article will only optimize the number of training epochs (i.e. iterations); basically this is testing for early stopping.</p>
<p>A function is needed to compute the model on the analysis set, predict the assessment set, and compute the holdout root mean squared error (in log10 units). The function below constructs the model sequentially and takes the number of epochs as a parameter. The argument <code>split</code> will be used to pass a single element of <code>cv_splits$splits</code>. This object will contain the two splits of the data for a single resample. The ellipses (<code>...</code>) will be used to pass arbitrary arguments to <code><a href="http://www.rdocumentation.org/packages/keras/topics/fit">keras::fit</a></code>.</p>
<p>In this function, the seed is set. A few of the model components, such as <code>initializer_glorot_uniform</code> and <code>layer_dropout</code>, use random numbers and their specific seeds are set from the session’s seed. This helps with reproducibility.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(keras)
<span class="kw">library</span>(yardstick)
<span class="kw">library</span>(purrr)

mlp_rmse &lt;-<span class="st"> </span><span class="cf">function</span>(epoch, split, ...) {
  <span class="co"># Set the seed to get reproducible starting values and dropouts</span>
  <span class="kw">set.seed</span>(<span class="dv">4109</span>)
  
  <span class="co"># Clearing the session after the computations have finished</span>
  <span class="co"># clears memory used by the last trial in preparation for </span>
  <span class="co"># the next iteration. </span>
  <span class="kw">on.exit</span>(keras<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/backend">backend</a></span>()<span class="op">$</span><span class="kw">clear_session</span>())
  
  <span class="co"># Define a single layer MLP with dropout and ReLUs</span>
  model &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/keras_model_sequential">keras_model_sequential</a></span>()
  model <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/layer_dense">layer_dense</a></span>(
      <span class="dt">units =</span> <span class="dv">10</span>, 
      <span class="dt">activation =</span> <span class="st">'relu'</span>, 
      <span class="dt">input_shape =</span> <span class="dv">2</span>,
      <span class="dt">kernel_initializer =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/initializer_glorot_uniform">initializer_glorot_uniform</a></span>()
    ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/layer_dropout">layer_dropout</a></span>(<span class="dt">rate =</span> <span class="fl">0.4</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/layer_dense">layer_dense</a></span>(<span class="dt">units =</span> <span class="dv">1</span>, <span class="dt">activation =</span> <span class="st">"linear"</span>)

  model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/compile">compile</a></span>(
    <span class="dt">loss =</span> <span class="st">'mean_squared_error'</span>,
    <span class="dt">optimizer =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/optimizer_rmsprop">optimizer_rmsprop</a></span>(),
    <span class="dt">metrics =</span> <span class="st">'mean_squared_error'</span>
  )
  
  <span class="co"># The data used for modeling (aka the "analysis" set)</span>
  geocode &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/as.data.frame.rsplit.html">analysis</a></span>(split) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>Sale_Price) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">as.matrix</span>()
  
  model <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/keras/topics/fit">fit</a></span>(
    <span class="dt">x =</span> geocode, 
    <span class="dt">y =</span> <span class="kw"><a href="../../reference/as.data.frame.rsplit.html">analysis</a></span>(split)[[<span class="st">"Sale_Price"</span>]], 
    <span class="dt">epochs =</span> epoch,
    ...
    )
  
  <span class="co"># Now obtain the holdout set for prediction</span>
  holdout &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/as.data.frame.rsplit.html">assessment</a></span>(split)
  pred_geocode &lt;-<span class="st"> </span>holdout <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="op">-</span>Sale_Price) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">as.matrix</span>()
  
  holdout<span class="op">$</span>predicted &lt;-<span class="st"> </span><span class="kw">predict</span>(model, pred_geocode)[,<span class="dv">1</span>]

  <span class="kw"><a href="http://www.rdocumentation.org/packages/yardstick/topics/rmse">rmse</a></span>(holdout, <span class="dt">truth =</span> Sale_Price, <span class="dt">estimate =</span> predicted)
}</code></pre></div>
<p>Let’s execute the function on the first fold of the data using a batch size of 128 and disable the print/plotting of the optimization:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cv_splits<span class="op">$</span>splits[[<span class="dv">1</span>]]</code></pre></div>
<pre><code>## &lt;1965/221/2186&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mlp_rmse</span>(
  <span class="dt">epoch =</span> <span class="dv">100</span>,
  cv_splits<span class="op">$</span>splits[[<span class="dv">1</span>]],
  <span class="co"># now options to keras::fit</span>
  <span class="dt">batch_size =</span> <span class="dv">128</span>, 
  <span class="dt">verbose =</span> <span class="dv">0</span>
)</code></pre></div>
<pre><code>## [1] 0.4420653</code></pre>
<p>This works for a single resample and a single epoch setting. To tune over epochs, another function uses <code>map</code> to work over the tuning parameter for a specific resample. This is more advantageous than fixing the tuning parameter and then iterating over the data. If there was a complex feature engineering process being used, it only needs to be called once if functions are configured so that the <em>inner</em> loop is over the tuning parameters.</p>
<p>The result value is a tibble with the tuning parameter values, the performance estimates, and an indicator for the fold.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">across_grid &lt;-<span class="st"> </span><span class="cf">function</span>(split, ...) {
  <span class="co"># Create grid</span>
  epoch_values &lt;-<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(<span class="dt">epoch =</span> <span class="kw">seq</span>(<span class="dv">50</span>, <span class="dv">600</span>, <span class="dt">by =</span> <span class="dv">50</span>)) 

  <span class="co"># Execute grid for this resample</span>
  epoch_values<span class="op">$</span>rmse &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_dbl</a></span>(
    epoch_values<span class="op">$</span>epoch, 
    mlp_rmse,
    <span class="dt">split =</span> split, 
    <span class="co"># extra options for `fit`</span>
    ...
  )
  <span class="co"># Now attach the resample indicators using `labels`</span>
  <span class="kw">cbind</span>(epoch_values, <span class="kw">labels</span>(split))
}</code></pre></div>
<p>Note that the grid could easily have a been multidimensional so that many parameters could be optimized using a regular grid or via <a href="http://www.jmlr.org/papers/v13/bergstra12a.html">random search</a>. If that were the case, the candidate tuning parameter values could be in rows and the parameters in columns and <code>mlp_rmse</code> would then map the columns in the tibble to their respective arguments.</p>
<p><code>map_df</code> is used to operate over the folds. This will row-bind the resulting data frames together so that a single data set is assembled with the individual resampling results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tune_results &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_df</a></span>(
    cv_splits<span class="op">$</span>splits,
    across_grid,
    <span class="dt">batch_size =</span> <span class="dv">128</span>, 
    <span class="dt">verbose =</span> <span class="dv">0</span>
  )</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(tune_results)</code></pre></div>
<pre><code>##   epoch      rmse     id
## 1    50 0.7654377 Fold01
## 2   100 0.3741241 Fold01
## 3   150 0.3820697 Fold01
## 4   200 0.2719558 Fold01
## 5   250 0.2158916 Fold01
## 6   300 0.1676901 Fold01</code></pre>
<p>The mean RMSE per epoch is computed and plotted along with the individual curves for each resample.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mean_values &lt;-<span class="st"> </span>tune_results <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(epoch) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">rmse =</span> <span class="kw">mean</span>(rmse))
mean_values</code></pre></div>
<pre><code>## # A tibble: 12 x 2
##    epoch      rmse
##    &lt;dbl&gt;     &lt;dbl&gt;
##  1    50 0.7582884
##  2   100 0.4011383
##  3   150 0.3118799
##  4   200 0.2477312
##  5   250 0.2056774
##  6   300 0.1680085
##  7   350 0.1501554
##  8   400 0.1454276
##  9   450 0.1451050
## 10   500 0.1450753
## 11   550 0.1452310
## 12   600 0.1446001</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(mean_values, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> epoch, <span class="dt">y =</span> rmse)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>() <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="dt">data =</span> tune_results, <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">group =</span> id), <span class="dt">alpha =</span> <span class="fl">0.1</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_continuous">scale_y_continuous</a></span>(<span class="dt">trans =</span> <span class="st">"log2"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="Keras_files/figure-html/resample-means-1.png" width="672"></p>
<p>For this analysis, there doesn’t seem to be any overfitting issues with a large number of iterations (since the RMSE does not increase).</p>
<p><code>caret</code> includes some <a href="https://topepo.github.io/caret/train-models-by-tag.html#Neural_Network">pre-defined <code>keras</code> models</a> for single layer networks that can be used to optimize the model across a number of parameters.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Max Kuhn, <a href="http://hadley.nz">Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
